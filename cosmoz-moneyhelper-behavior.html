<link rel="import" href="../polymer/polymer.html"/>

<script type="text/javascript">
	(function () {
		'use strict';
		window.Cosmoz = window.Cosmoz || {};

		const CURRENCY_FORMATTERS = {},
			NUMBER_FORMATTER = new Intl.NumberFormat(undefined, {
				minimumFractionDigits: 2,
				maximumFractionDigits: 2
			});

		/**
		 * Behavior for amount and money management.
		 *
		 * @polymerBehavior Cosmoz.MoneyHelperBehavior
		 * @demo
		 */
		Cosmoz.MoneyHelperBehavior = {
			/**
			 * Compare amounts.
			 * @param {object} amount1 Amount 1.
			 * @param {object} amount2 Amount 2.
			 * @param {number} precision Decimal precision, defaults to 2 decimals.
			 * @returns {boolean} Whether the amounts are equal regarding amount to the specified precision and the currency.
			 */
			amountEquals(amount1, amount2, precision = 2) {
				return this.isAmount(amount1) && this.isAmount(amount2) &&
					this.round(amount1.amount, precision) === this.round(amount2.amount, precision) &&
					amount1.currency === amount2.currency;
			},
			/**
			 * Determine if a constant or a variable is an amount.
			 * @param {object} potentialAmount Potential amount.
			 * @returns {boolean} Whether the potential amount is a valid amount object with amount and currency.
			 */
			isAmount(potentialAmount) {
				return potentialAmount != null &&
					potentialAmount.amount != null &&
					potentialAmount.currency != null &&
					typeof potentialAmount.amount === 'number' &&
					typeof potentialAmount.currency === 'string' &&
					potentialAmount.currency.length === 3;
			},
			/**
			 * Render an amount with decimal separator and currency symbol.
			 * @param  {object} money Money with amount property and optionally currency property.
			 * @return {string} Formatted amount.
			 */
			renderAmount(money) {
				if (money == null) {
					return;
				}
				const formatter = this._getCurrencyFormatter(money.currency);
				if (formatter == null) {
					return;
				}
				return formatter.format(money.amount);
			},
			/**
			 * Alias for renderAmount(money). Render an amount with decimal separator and currency symbol.
			 * @param  {object} money Money with amount property and optionally currency property.
			 * @return {string} Formatted amount.
			 */
			renderMoney(money) {
				return this.renderAmount(money);
			},
			/**
			 * Render an amount with decimal separator but without currency symbol.
			 * @param  {object} money Money with amount property and optionally currency property.
			 * @return {string} Formatted number.
			 */
			renderNumberAmount(money) {
				return NUMBER_FORMATTER.format(money.amount);
			},
			/**
			 * Round a number to a given precision.
			 * @param  {string} number Number with decimals to round.
			 * @param  {number} precision Number of decimals to round amount to.
			 * @return {number} Rounded number.
			 */
			round(number, precision) {
				const fixed = Number(Math.round(number + 'e' + precision) + 'e-' + precision).toFixed(precision);
				return parseFloat(fixed);
			},
			_getCurrencyFormatter(currency) {
				if (currency == null) {
					return;
				}
				const key = currency.toUpperCase();
				if (CURRENCY_FORMATTERS[key] == null) {
					CURRENCY_FORMATTERS[key] = new Intl.NumberFormat(undefined, {
						style: 'currency',
						currency
					});
				}
				return CURRENCY_FORMATTERS[key];
			}
		};
	}());
</script>